{% load static %}
<div id="new_rate_4_final" class="modal modal-md my-modal chase-modal">
    <div class="modal-content w-75 h-50 m-auto" style="background-image: url(../../../static/images/step-form-border.png);
    background-repeat: no-repeat;
    background-size: contain;
    background-position: top center;">
        <span class="close" onclick="document.getElementById('new_rate_4_final').style.display='none'">&times;</span>
        <br>  
        <div class="heading-container text-center mb-5">
        <h3 class="heading">New Rate</h3>
        </div>      
        <div class="progress-icons">
        <div id="progress_0" class="progress-active"></div>
        <div id="progress_1" class="progress-active"></div>
        <div id="progress_2" class="progress-active"></div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-3"></div>
            <div class="col-md-6">  
                <br>     
                <br>   
                <div class="row">
                    <div class="col-md-12 text-center">                        
                        <h2 class="success-label">Rate has been created!</h2>
                        <div id="favoriteIcon1" class="mt-2 adsuccess-mark" style="width: 202px; height: 202px;border-radius: 50%;background-color: #03A803;margin-left: auto;margin-right: auto;">
                            <img src="{% static "svg/Vector (2).svg" %}" style="height: 140px; margin-top: 35px;">
                        </div>
                    </div>
                </div>  
                <br>     
                <br>     
                <br>                
                <div class="row btn-container">
                    <div class="col-md-6 text-left">
                        <button class="btn px-5 btn-gray" onclick="done(1)"> Create another rate  </button>
                    </div>
                    <div class="col-md-6 text-right">
                        <button class="btn btn-secondary px-5" onclick="done(2)"> Done  </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function done(index) {
            // Create a new row (tr) with the desired content
            var id = document.getElementById('rategroup_id').dataset.value;
            var tbody = document.getElementById('rate-table-body');
            // Get the last child element (last <tr> element) within the tbody
            var lastTr = tbody.lastElementChild;
            var lastRateId = 0
            // Check if the lastTr is a <tr> element
            if (lastTr.tagName === 'TR') {
                // Get the ID of the last rate element from the last <tr> element
                var lastRateId = lastTr.querySelector('td:first-child').textContent;
            }
            let form = $('#rate-general-info-form');
            var formData = new FormData(form[0]);
            let data = {};
            
            for (const [key, value] of formData) {
                data[key] = value;
            }
            if(data['pricing']) {
                data['pricing'] = 'STANDARD';
            } else {
                data['pricing'] = 'CUSTOMARY';
            }
            if(data['override_privileges']) {
                data['override_privileges'] = true;
            } else {
                data['override_privileges'] = false;
            }
            if(data['assigned_groups']) {
                data['assigned_groups'] = true;
            } else {
                data['assigned_groups'] = false;
            }
            var selectElement = document.getElementById('extra_lstBox1');
            var values = [id];
            
            for (var i = 0; i < selectElement.options.length; i++) {
                values.push(selectElement.options[i].value);
            }
            data['extra_groups'] = JSON.stringify(values);
            form = $('#rate-dates-form');
            formData = new FormData(form[0]);
            
            for (const [key, value] of formData) {
                data[key] = value;
            }
            var newRowContent = `
            <tr>
                <td>${Number(lastRateId) + 1}</td>
                <td>${data['name']}</td>
                <td>${data['measurement_type']}</td>
                <td>${data['pricing']}</td>
                <td>${data['default_gl_code']}</td>
                <td>${data['tax_category']}</td>
                <td>${data['start_date']}</td>
                <td>${data['end_date']}</td>
                <td>
                    <div class="switch2">
                        <input id="cc-toggle" class="check-toggle check-toggle-round-flat" type="checkbox" />
                        <label for="cc-toggle"></label>    
                        <span class="active">Active</span>
                        <span class="deactivate">Deactivate</span>
                    </div>
                </td>
                <td>
                    <span class="pe-5"><i class="fa fa-solid fa-pencil"></i></span>
                    <span><i class="fa fa-solid fa-envelope-open"></i></span>
                </td>
            </tr>
            `;
    
            // Insert the new row into the tbody at the end
            tbody.insertAdjacentHTML('beforeend', newRowContent);
            if(index == 1) document.getElementById('new_rate_1_general_info').style.display='block';
            document.getElementById('new_rate_4_final').style.display='none';
        }
    </script>
  </div>